{% extends "base.html" %}
{% load i18n %}
{% load humanize %}

{% block page_title %}{% trans "Raporlar" %}{% endblock %}

{% block content %}
<style>
/* Gradient Cards */
.bg-gradient-success { background: linear-gradient(45deg, #10b981, #059669) !important; }
.bg-gradient-danger { background: linear-gradient(45deg, #ef4444, #b91c1c) !important; }
.bg-gradient-info { background: linear-gradient(45deg, #3b82f6, #1d4ed8) !important; }
.bg-gradient-primary { background: linear-gradient(45deg, #6366f1, #4338ca) !important; }
.bg-gradient-warning { background: linear-gradient(45deg, #f59e0b, #d97706) !important; }

/* Stat Card */
.card-stat {
    border: none !important;
    overflow: hidden;
    position: relative;
    border-radius: 16px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    transition: transform 0.2s;
}
.card-stat:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
}
.card-stat .text-white { color: #ffffff !important; }
.card-stat .icon-box {
    position: absolute;
    right: 20px;
    bottom: 20px;
    opacity: 0.3;
    transform: rotate(-10deg) scale(1.2);
    color: white;
}

/* Modern Typography */
.fs-7 { font-size: 0.8rem; }
.ls-1 { letter-spacing: 1px; }

/* Chart Card */
.chart-container {
    position: relative;
    height: 350px;
    width: 100%;
}
</style>

<div class="container-fluid p-0">
    <!-- Header Controls -->
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4">
        <h5 class="fw-bold mb-3 mb-md-0 text-gray-800"><i class="fas fa-chart-line me-2 text-primary"></i>{% trans "Detaylı Raporlama" %}</h5>
        
        <div class="d-flex gap-2">
             <button class="btn btn-primary-custom btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCardFilters">
                <i class="fas fa-filter me-2"></i>{% trans "Filtrele" %}
            </button>
            <a href="{% url 'export-reports-csv' %}?{{ current_params }}" class="btn btn-success btn-sm rounded-pill px-3 fw-bold">
                <i class="fas fa-file-csv me-2"></i>{% trans "CSV İndir" %}
            </a>
        </div>
    </div>

    <!-- Collapsible Filter -->
    <div class="collapse mb-4 {% if request.GET %}show{% endif %}" id="collapseCardFilters">
        <div class="card card-custom border-0 shadow-sm">
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label text-uppercase fs-7 text-muted fw-bold">{% trans "Date Range" %}</label>
                        {{ filter.form.created_at }} 
                    </div>
                    <div class="col-md-2">
                        <label class="form-label text-uppercase fs-7 text-muted fw-bold">{% trans "Type" %}</label>
                        {{ filter.form.transaction_type }}
                    </div>
                    <div class="col-md-2">
                        <label class="form-label text-uppercase fs-7 text-muted fw-bold">{% trans "Status" %}</label>
                        {{ filter.form.status }}
                    </div>
                    {% if user.is_superadmin %}
                    <div class="col-md-3">
                        <label class="form-label text-uppercase fs-7 text-muted fw-bold">{% trans "SubDealer" %}</label>
                        {{ filter.form.sub_dealer }}
                    </div>
                    {% endif %}
                    
                    <div class="col-md-2 d-flex align-items-end gap-2">
                        <button type="submit" class="btn btn-primary w-100 rounded-pill"><i class="fas fa-search me-1"></i> Ara</button>
                        <a href="{% url 'daily-report-page' %}" class="btn btn-light w-100 rounded-pill border"><i class="fas fa-eraser"></i></a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Premium Stat Cards -->
    <div class="row mb-4">
        <!-- Deposits -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card card-stat bg-gradient-success h-100">
                <div class="card-body p-4">
                     <h6 class="text-uppercase ls-1 text-white opacity-75 mb-2" style="font-size: 0.75rem;">Top. Yatırım</h6>
                     <h2 class="mb-0 fw-bold text-white display-6">{{ total_deposit|default:0|floatformat:2|intcomma }} ₺</h2>
                     <div class="icon-box">
                        <i class="fas fa-arrow-trend-up fa-3x"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Withdrawals -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card card-stat bg-gradient-danger h-100">
                <div class="card-body p-4">
                     <h6 class="text-uppercase ls-1 text-white opacity-75 mb-2" style="font-size: 0.75rem;">Top. Çekim</h6>
                     <h2 class="mb-0 fw-bold text-white display-6">{{ total_withdraw|default:0|floatformat:2|intcomma }} ₺</h2>
                     <div class="icon-box">
                        <i class="fas fa-arrow-trend-down fa-3x"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Net Flow -->
        <div class="col-xl-3 col-md-6 mb-4">
             <div class="card card-stat bg-gradient-info h-100">
                <div class="card-body p-4">
                     <h6 class="text-uppercase ls-1 text-white opacity-75 mb-2" style="font-size: 0.75rem;">Net Kasa</h6>
                     <h2 class="mb-0 fw-bold text-white display-6">{{ net_flow|default:0|floatformat:2|intcomma }} ₺</h2>
                     <div class="icon-box">
                        <i class="fas fa-balance-scale fa-3x"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Commission -->
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card card-stat bg-gradient-warning h-100">
                <div class="card-body p-4">
                     <h6 class="text-uppercase ls-1 text-white opacity-75 mb-2" style="font-size: 0.75rem;">Tahmini Komisyon</h6>
                     <h2 class="mb-0 fw-bold text-white display-6">{{ total_commission|default:0|floatformat:2|intcomma }} ₺</h2>
                     <div class="icon-box">
                        <i class="fas fa-percentage fa-3x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Row: Table Only -->
    <div class="row">
        <!-- Transactions Table -->
        <div class="col-12 mb-4">
            <div class="card card-custom h-100">
                <div class="card-header-custom border-bottom pb-3 mb-3">
                    <h6 class="fw-bold m-0 text-primary">{% trans "İşlem Dökümü" %}</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                        <table class="table-modern w-100 align-middle">
                            <thead class="sticky-top bg-white">
                                <tr>
                                    <th>ID</th>
                                    <th>{% trans "İŞLEM TİPİ" %}</th>
                                    <th>{% trans "BAYİ / KULLANICI" %}</th>
                                    <th>{% trans "TUTAR" %}</th>
                                    <th>{% trans "DETAY / KAYNAK" %}</th>
                                    <th>{% trans "Tarih/Saat" %}</th>
                                    <th>{% trans "DURUM" %}</th>
                                    <th class="text-end">{% trans "AKSİYON" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for tx in transactions %}
                                <tr>
                                    <td><span class="text-muted small">#{{ tx.id }}</span></td>
                                    <td>
                                        {% if tx.transaction_type == 'DEPOSIT' %}
                                        <div class="d-flex align-items-center">
                                            <div class="avatar avatar-sm bg-gradient-success me-2 rounded-circle d-flex align-items-center justify-content-center" style="width:32px; height:32px;">
                                                <i class="fas fa-arrow-down text-white"></i>
                                            </div>
                                            <span class="fw-bold text-success">YATIRIM</span>
                                        </div>
                                        {% elif tx.transaction_type == 'WITHDRAW' %}
                                        <div class="d-flex align-items-center">
                                            <div class="avatar avatar-sm bg-gradient-danger me-2 rounded-circle d-flex align-items-center justify-content-center" style="width:32px; height:32px;">
                                                <i class="fas fa-arrow-up text-white"></i>
                                            </div>
                                            <span class="fw-bold text-danger">ÇEKİM</span>
                                        </div>
                                        {% else %}
                                        <div class="d-flex align-items-center">
                                            <div class="avatar avatar-sm bg-primary-subtle me-2 rounded-circle d-flex align-items-center justify-content-center" style="width:32px; height:32px;">
                                                <i class="fas fa-cog text-primary"></i>
                                            </div>
                                            <span class="fw-bold text-primary">MANUEL</span>
                                        </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar avatar-sm bg-light text-primary me-2 rounded-circle d-flex align-items-center justify-content-center fw-bold" style="width:32px; height:32px;">
                                                {{ tx.sub_dealer.user.username|make_list|first|upper }}
                                            </div>
                                            <div class="d-flex flex-column">
                                                <span class="fw-bold text-dark">{{ tx.sub_dealer.user.username }}</span>
                                                <small class="text-muted">Bayi</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="fw-bold font-monospace fs-6 text-dark">
                                        {{ tx.amount|floatformat:2|intcomma }} ₺
                                    </td>
                                    <td>
                                        {% if tx.transaction_type == 'MANUAL_CREDIT' or tx.transaction_type == 'MANUAL_DEBIT' %}
                                            <div class="d-flex flex-column">
                                                {% if tx.category %}
                                                    {% if tx.transaction_type == 'MANUAL_CREDIT' %}
                                                        <span class="badge bg-soft-primary text-primary fw-bold mb-1 w-auto align-self-start border border-primary-subtle">
                                                            {{ tx.get_category_display }}
                                                        </span>
                                                    {% else %}
                                                        <span class="badge bg-soft-warning text-warning fw-bold mb-1 w-auto align-self-start border border-warning-subtle">
                                                             {{ tx.get_category_display }}
                                                        </span>
                                                    {% endif %}
                                                {% else %}
                                                   <span class="badge bg-soft-secondary text-secondary fw-bold mb-1 w-auto align-self-start">Manuel İşlem</span>
                                                {% endif %}
                                    
                                                {% if tx.description %}
                                                <small class="text-muted fst-italic" style="font-size: 0.8rem; line-height: 1.2;">
                                                    {{ tx.description|truncatechars:50 }}
                                                </small>
                                                {% endif %}
                                                
                                                {% if tx.processed_by %}
                                                <div class="mt-1 small text-primary" style="font-size: 0.75rem;">
                                                    <i class="fas fa-user-check me-1 opacity-50"></i> {{ tx.processed_by.username }}
                                                </div>
                                                {% endif %}
                                            </div>
                                        {% elif tx.bank_account %}
                                        <div class="d-flex align-items-center">
                                             <div class="me-2 text-primary opacity-75">
                                                 <i class="{{ tx.bank_account.bank_icon_class|default:'fas fa-university' }} fa-lg"></i>
                                             </div>
                                             <div class="d-flex flex-column">
                                                <span class="fw-bold text-dark fs-7">{{ tx.bank_account.bank_name }}</span>
                                                <small class="text-muted font-monospace" style="font-size: 0.75rem;">
                                                    {{ tx.bank_account.formatted_iban|default:tx.bank_account.iban }}
                                                </small>
                                             </div>
                                        </div>
                                        {% else %}
                                        <span class="text-muted small">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="d-flex flex-column">
                                            <span class="fw-bold text-dark fs-7">{{ tx.created_at|date:"d M Y" }}</span>
                                            <small class="text-muted">{{ tx.created_at|date:"H:i" }}</small>
                                        </div>
                                    </td>
                                    <td>
                                        {% if tx.status == 'APPROVED' %}
                                            <span class="badge badge-soft-success rounded-pill px-3">
                                                <i class="fas fa-check-circle me-1"></i> ONAYLANDI
                                            </span>
                                        {% elif tx.status == 'PENDING' %}
                                            <span class="badge badge-soft-warning rounded-pill px-3">
                                                <i class="fas fa-clock me-1"></i> BEKLİYOR
                                            </span>
                                        {% elif tx.status == 'REJECTED' %}
                                            <span class="badge badge-soft-danger rounded-pill px-3 position-relative" data-bs-toggle="tooltip" data-bs-placement="top" title="Sebebi: {{ tx.rejection_reason|default:'Belirtilmemiş' }}">
                                                <i class="fas fa-times-circle me-1"></i> REDDEDİLDİ
                                                <span class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle" style="width: 10px; height: 10px;"></span>
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% if user.is_superadmin and tx.status == 'REJECTED' %}
                                        <form action="{% url 'transaction-action' tx.id 'requeue' %}" method="POST" class="d-inline" onsubmit="return confirm('Bu işlemi tekrar bekleyenlere almak istiyor musunuz?');">
                                            {% csrf_token %}
                                            <button type="submit" class="btn btn-icon btn-light btn-sm text-warning" data-bs-toggle="tooltip" title="Tekrar İşleme Al">
                                                <i class="fas fa-undo"></i>
                                            </button>
                                        </form>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center py-5">
                                        <div class="text-muted opacity-50">
                                            <i class="fas fa-search-dollar fa-3x mb-3"></i>
                                            <p class="mb-0">Kriterlere uygun işlem bulunamadı.</p>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Chart functionality removed from view, keeping script tag if needed for other things or removing it entirely -->
{% endblock %}
